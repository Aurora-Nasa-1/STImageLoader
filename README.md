# Post-Reply Image Inserter - SillyTavern 插件

一个强大的 SillyTavern 插件，利用独立的 AI API 生成图像提示词，然后通过 ComfyUI 生成图像并插入到聊天中。

## 🌟 主要功能

### 🤖 AI 驱动的图像生成
- **智能提示词分析**: 使用 OpenAI 或 Claude API 分析对话内容，自动生成高质量图像提示词
- **增强提示词系统**: 内置默认正面和负面提示词库，提升图像质量
- **多模型支持**: 支持 OpenAI GPT 系列和 Claude 系列模型

### 🎨 图像生成与显示
- **ComfyUI 集成**: 与 ComfyUI 无缝集成，支持多种工作流模板
- **智能回退机制**: 图像生成失败时自动使用角色卡图片作为回退
- **高级预览功能**: 支持图片预览、放大查看和控制按钮
- **图片历史画廊**: 内置图片历史记录和画廊浏览功能

### ⚙️ 丰富的配置选项
- **角色卡图片支持**: 可自定义图像或自动使用角色卡图片
- **图片位置控制**: 支持图片在消息顶部或底部插入
- **缓存系统**: 智能图片缓存，避免重复生成
- **历史记录**: 完整的图片生成历史记录和管理

### 🎯 用户界面增强
- **现代化 UI**: 美观的设置面板和图片显示界面
- **响应式设计**: 适配移动端和桌面端
- **暗色主题**: 支持暗色主题模式
- **快捷操作**: 提供多个快捷按钮和 slash 命令

## 🚀 安装和使用

### 安装步骤
1. 将插件文件夹复制到 SillyTavern 的 `plugins` 目录
2. 重启 SillyTavern
3. 在设置面板中配置 API 密钥和 ComfyUI 地址

### 基本配置
1. **AI 提供商设置**: 配置 OpenAI 或 Claude API 密钥
2. **ComfyUI 配置**: 设置 ComfyUI 服务器地址
3. **工作流模板**: 选择或自定义 ComfyUI 工作流

### 使用方式

#### 自动模式
- 启用"自动触发图像生成"后，AI 回复时会自动生成相关图像
- 插件会分析对话内容并生成合适的图像提示词

#### 手动模式
- 使用 `/insertimg <提示词>` 命令手动生成图像
- 点击聊天控制栏的图片按钮
- 使用 `/img-character` 插入角色卡图片

#### 画廊功能
- `/img-gallery` - 显示图片历史画廊
- `/img-clear-history` - 清空图片历史记录

## ⚙️ 高级设置

### 提示词配置
- **默认正面提示词**: 每行一个，随机选择添加到生成提示词中
- **负面提示词**: 每行一个，组合成负面提示词

### 图像生成参数
- **图片位置**: 控制图片在消息中的插入位置
- **最大图片数量**: 限制历史记录中的图片数量
- **重试次数**: 图像生成失败时的重试次数

### 高级功能
- **图片预览**: 启用后显示图片控制按钮
- **图片历史**: 启用图片历史记录功能
- **图片缓存**: 缓存生成的图片避免重复生成

## 🛠️ 技术特性

### 错误处理和回退
- 智能错误检测和处理
- 多重回退机制确保用户体验
- 详细的日志和通知系统

### 性能优化
- 智能图片缓存系统
- 异步生成和处理
- 优化的 API 调用策略

### 扩展性
- 模块化设计，易于扩展
- 支持自定义工作流模板
- 灵活的配置系统

## 🔧 故障排除

### 常见问题
1. **API 连接失败**: 检查 API 密钥和网络连接
2. **ComfyUI 连接问题**: 确认 ComfyUI 地址和端口
3. **图像生成失败**: 检查工作流模板和参数设置

### 调试模式
- 启用"显示详细通知"获取更多信息
- 查看浏览器控制台获取详细错误日志

## 📋 更新日志

### v1.0.0
- 初始版本发布
- 基础 AI 提示词生成
- ComfyUI 集成
- 基本图片显示功能

### v1.1.0
- 添加角色卡图片支持
- 增强图片预览功能
- 图片历史画廊
- 高级设置面板

## 🤝 贡献

欢迎提交 Issue 和 Pull Request 来改进这个插件！

## 📄 许可证

MIT License - 详见 LICENSE 文件